---
title: "Time series analysis for COVID19 Cases Trends by Country"
author: Andres Hernandez
date: "04/02/2020"
output:
  html_document: default    
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(rjson)
library(CausalImpact)
library(TTR)
library(imputeTS)
setwd("~/Documents/Projects/Coronavirus/GITCOVID19/COVID19")
graphics.off()
```

## Data Sources
Data for COVID19 updated until April 6th, 2020 comes from [COVID19-TIMESERIES](https://pomber.github.io/covid19/timeseries.json).

Data for Daily testing from [COVID19-TESTING](https://ourworldindata.org/covid-testing)
[COVID19-TESTING-Sources](https://ourworldindata.org/covid-testing#source-information-country-by-country)

Data for european measures can be found in [Report COVID19 Europe](https://www.imperial.ac.uk/media/imperial-college/medicine/mrc-gida/2020-03-30-COVID19-Report-13.pdf)

```{r load, include=FALSE}
result <- fromJSON(file = "timeseries4.json") # data from the COVID19
testing <- read.csv("covid19test3.csv", header = TRUE)
testing_permillion <- read.csv("covid19test_permillion2.csv", header = TRUE)
```

## Processing the data

Data is read by country, change the country for the country of your interest. Then n and interval parameters are used for aggregating data and set the interval of analysis for the time trend. 

n is the aggregation parameter in days, if we set n to 7 we sample cases each week. 

interval parametes choose the number of time periods to take into account for the trending change analysis. (If we select n = 5, interval = 2, it means that the trending change will take into account 10 days before and after to analyze if there was a change in the trending).

Analysis in trending changes is conducted using the causal analysis library. More information about this library refer to the link below. 
[Causal Impact](https://research.google/pubs/pub41854/)
[Paper](https://projecteuclid.org/download/pdfview_1/euclid.aoas/1430226092)

Analysis is conducted over the discrete derivative of the logarithmic of the ratio between the cumulative confirmed cases vs. the total testing, as cases are exponentially distributed the log will result in the linear trend and the derivative will show the pendent. The time series will analyze increasing or decreasing trends on the pendent of the exponential growth rate.

```{r countries, include=FALSE, echo=FALSE}
countries_list <- c(
"Austria",
"Belgium",
"Estonia",
"Iceland",
"Finland",
"France",
"Italy",
"Japan",
"Malaysia",
"South Africa",
"South Korea",
"United Kingdom"
)
```

```{r processing, include=TRUE, warning=FALSE}
Country <- "Italy" # Select the country
Country2 <- "Italy"
ResultsByCountry <- result[[Country]] 
CountryNamesList <- strsplit(as.character(testing$Entity), " - ")
CountryName <- c()
for (element in CountryNamesList){
  CountryName <- c(CountryName, element[1])
}
testing$Country <- CountryName

# clipr::write_clip(rownames(as.matrix(table(testing$Country))))
# clipr::write_clip(as.matrix(table(testing$Country)))

TestByCountry <- testing[testing$Country == Country2,] # select country (pendent for creating a 
TestByCountry$TestDate <- as.Date(TestByCountry$Date,format='%B %d, %Y')
TestByCountry$DailyTest <- c(TestByCountry$Cumulative.total.tests[1],diff(TestByCountry$Cumulative.total.tests))

TestByCountry_pm <- testing_permillion[testing$Country == Country2,] # select country (pendent for creating a
TestByCountry_pm$TestDate <- as.Date(TestByCountry$Date,format='%B %d, %Y')

dates <- c()
deaths <- c()
recovered <- c()
confirmed <- c()
tests <- c()
tests_pm <- c()

for(element in ResultsByCountry){
  currentDate <- as.Date(element$date)
  dates <- c(dates, as.character(currentDate))
  deaths <- c(deaths, element$deaths)
  recovered <- c(recovered, element$recovered)
  confirmed <- c(confirmed, element$confirmed)

  if(currentDate %in% TestByCountry$TestDate){
    tests <- c(tests, TestByCountry[TestByCountry$TestDate==currentDate,]$Cumulative.total.tests)
    tests_pm <- c(tests_pm, TestByCountry_pm[TestByCountry_pm$TestDate==currentDate,]$Cumulative.total.tests)
  } else {
    tests <- c(tests, NA)
    tests_pm <- c(tests_pm, NA)
  }
}

data_frame_analysis <- data.frame(dates = as.Date(dates), deaths = deaths, recovered = recovered, confirmed = confirmed, tests = tests, test_pm = tests_pm)

counter <- 0
temp <- rep(TRUE, length(data_frame_analysis$tests))
for (element in data_frame_analysis$tests){
  counter <- counter + 1
  if(is.na(element)){
    temp[counter] <- FALSE
  } else {
    break
  }
}
counter <- length(data_frame_analysis$tests)
for (element in rev(data_frame_analysis$tests)){
  if(is.na(element)){
    temp[counter] <- FALSE
  } else {
    break
  }
  counter <- counter - 1
}

data_frame_analysis_temp <- data_frame_analysis[temp,]
data_frame_analysis_temp$time <- 1:length(data_frame_analysis_temp$tests)
data_frame_analysis_temp$tests_int <- na.kalman(data_frame_analysis_temp$tests)
data_frame_analysis_temp$tests_pm_int <- na.kalman(data_frame_analysis_temp$test_pm)
data_frame_analysis_complete <- data_frame_analysis_temp
dates <- data_frame_analysis_complete$dates

cumulated <- data_frame_analysis_complete$confirmed/data_frame_analysis_complete$tests_int # cumsum confirmed vs. cumsum testing
analysis <- cumulated # Select between confirmed, recovered, deaths, cumulated

# Analysis is the rate of change of confirmed/testing (speed)

CasesAdjusted <- analysis
timeseries_Real_T <- ts(CasesAdjusted, start = 1, end = length(CasesAdjusted))
n <- 1
interval <- 6

dates_resample <- dates[seq(1, length(dates)-n, n)]
timeseries_resample <- timeseries_Real_T[seq(1,length(timeseries_Real_T)-n, n)]
testtsint_resample <- data_frame_analysis_complete$tests_int[seq(1,length(data_frame_analysis_complete$tests_int)-n, n)]

testtsint_resample_pm <- data_frame_analysis_complete$tests_pm_int[seq(1,length(data_frame_analysis_complete$tests_pm_int)-n, n)]

dataSMA <- timeseries_resample
# dataSMA <- log(dataSMA)
# dataSMA <- c(0,diff(dataSMA)) # Speed
dataSMA <- c(0, c(0,diff(dataSMA))) # Accel
data <- dataSMA

datatestingSMA <- testtsint_resample
# datatestingSMA <- c(0,diff(datatestingSMA)) # Speed
datatestingSMA <- c(0, c(0,diff(datatestingSMA))) # Accel
datatesting <- datatestingSMA

data_scaled <- data

startint <- 1
endint <- length(data_scaled)

pvaluesig_ind <- c()
pvaluesig2_ind <- c()
modelbest_ind <- c()
modelbest_ind_report <- c()
pvaluesig_date <- c()

for (element in seq(startint, endint - 2 * interval, 1)){
  testperiod <- element + interval
  pre.period <- c(testperiod-interval, testperiod)
  post.period <- c(testperiod+1, testperiod+1+interval)
  impact <- CausalImpact(data_scaled, pre.period, post.period)
  pvalue <- impact$summary$p[1]
  if(is.null(pvalue)){
    pvaluesig2_ind <- c(pvaluesig2_ind, 1)
    modelbest_ind_report[length(modelbest_ind_report)+1] <- NA
    modelbest_ind[length(modelbest_ind)+1] <- NA
  } else {
    pvaluesig2_ind <- c(pvaluesig2_ind, pvalue)
    modelbest_ind_report[length(modelbest_ind_report)+1] <- impact$report
    modelbest_ind[length(modelbest_ind)+1] <- impact$summary
  }
  pvaluesig_ind <- c(pvaluesig_ind, testperiod)
  pvaluesig_date <- c(pvaluesig_date, as.character(dates_resample[testperiod]))
}

p_value_area <- c()
for (element in pvaluesig2_ind){
  if(element < 0.05){
    p_value_area <- c(p_value_area, 1)
  } else {
    p_value_area <- c(p_value_area, 0)
  }
}
```
  
## Plotting results

```{r plot, include=TRUE}
red <- 17
blue <- 15
yellow <- 11

# topval <- max(timeseries_resample)
topval <- 0.5
scale <- 0.05
# par(mfrow=c(3,1))
plot(
  1:length(timeseries_resample), 
  timeseries_resample, 
  type = "o",
  col="black",
  pch=18,
  lwd=2,
  lty=1,
  cex=1,
  xaxt="n",
  xlab="",
  ylab = "confirmed cases",
  ylim = c(0, max(max(timeseries_resample),topval+scale)),
  main = paste(Country, "cumulative confirmed vs. cumulative testing", sep = " "),
  bty="n"
)
scaled_area <- 100
pvaluesig_ind.2 <- seq(pvaluesig_ind[1], pvaluesig_ind[length(pvaluesig_ind)] + 1 - (1/scaled_area), (1/scaled_area))
p_value_area.2 <- c()
for (element in p_value_area){
  p_value_area.2 <- c(p_value_area.2, rep(element, scaled_area))
}
x.poly <- c(pvaluesig_ind.2, pvaluesig_ind.2[length(pvaluesig_ind.2)], pvaluesig_ind.2[1])
y.poly <- c(p_value_area.2, 0, 0)
polygon(x.poly, y.poly, col=c("#0C92C255"), border=1)
points(
  1:length(testtsint_resample_pm), 
  testtsint_resample_pm*(topval/max(testtsint_resample_pm)),
  type = "o",
  col="red",
  pch=18,
  lwd=2,
  lty=1,
  cex=1,
)

#yellow - schools closure
points(
yellow,
0,
cex = 1,
pch=21,  
col = "black",
bg="yellow",
lwd=2,
lty=1,
)
#blue - public events # 10=14-03-2020
points(
blue,
0,
cex = 1,
pch=21,  
col = "black",
bg="blue",
lwd=2,
lty=1,
)
#red - lockdown
points(
red,
0,
cex = 1,
pch=21,  
col = "black",
bg="red",
lwd=2,
lty=1,
)
axis(
  1, 
  at = 1:length(dates_resample), 
  labels = dates_resample, 
  las=2,
  cex.axis=0.7
  )

axis(
  4, 
  at = seq(0,topval, scale), 
  labels = round(seq(0,max(as.numeric(testtsint_resample_pm)), max(testtsint_resample_pm)/(length(seq(0,topval, scale))-1)), 2), 
  las=1,
  cex.axis=0.5,
  pos = length(dates_resample) + 0.5
  )
legend(
  "topleft", 
       legend=c("cases/testing",
                "Testing per thousands (right axis)",
                "School closure",
                "Public events banned",
                "lockdown"
                ),
       col=c("black", "red", "black", "black", "black"), 
       pt.bg=c(NA,NA,"yellow", "blue", "red"),
       lty=c(1, 1, NA, NA, NA),
       lwd=c(2, 2, 2, 2, 2),
       cex=0.6,
       pch=c(18, 18, 21, 21, 21),
       # bty = "n",
       pt.cex = 1
)
plot(
  1:length(data_scaled), 
  data_scaled,
  type = "o",
  col="black",
  pch=18,
  lwd=2,
  lty=1,
  cex=1,
  xaxt="n",
  xlab="",
  ylab = "trending growth rate", #  d2(log(cases))/dt2
  # ylim = c(min(data_scaled[!is.na(data_scaled)]),max(max(data_scaled[!is.na(data_scaled)]),max(datatesting[!is.na(datatesting)]*0.001)))
)
#yellow - schools closure
points(
yellow,
0,
cex = 1,
pch=21,  
col = "black",
bg="yellow",
lwd=2,
lty=1,
)
#blue - public events # 10=14-03-2020
points(
blue,
0,
cex = 1,
pch=21,  
col = "black",
bg="blue",
lwd=2,
lty=1,
)
#red - lockdown
points(
red,
0,
cex = 1,
pch=21,  
col = "black",
bg="red",
lwd=2,
lty=1,
)
polygon(x.poly, y.poly, col=c("#0C92C255"), border=1)
axis(1, at = 1:length(dates_resample), labels =dates_resample, las=2, cex.axis=0.7)
legend(
  "topleft", 
       legend=c("Growth rate d2(Cases/testing)/dt2",
                "School closure",
                "Public events banned",
                "lockdown"
                ),
       col=c("black", "black", "black", "black"), 
       pt.bg=c(NA,"yellow", "blue", "red"),
       lty=c(1, NA, NA, NA),
       lwd=c(2, 2, 2, 2),
       cex=0.6,
       pch=c(18, 21, 21, 21),
       # bty = "n",
       pt.cex = 1
)

```

Blue areas are time periods where the p-value of the trending change resulted in significant results. We usually accept as significant p-value < 0.005.


```{r summary}
date_analysis <- 20
Country
modelbest_ind[date_analysis]
modelbest_ind_report[date_analysis]
pvaluesig_date[date_analysis]
```